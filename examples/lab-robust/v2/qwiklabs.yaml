schema_version: 2
entity_type: Lab

title: Robust Lab Example
description: Seriously the best lab you've ever taken. Bar none.
default_locale: en
duration: 60
level: easy
tags:
  - sample
  - life-changing
  - gcp

resources:
  - type: file
    title: Sample PDF
    description: This PDF contains all of the code samples for the lab.
    uri: resources/sample-en.pdf
  - type: video
    id: intro-video
    title: Welcome to GCP!
    uri: https://www.youtu.be/oHg5SJYRHA0
    description: Overview of Google Cloud Platform
    duration: 360

environment:
  resources:
    - type: gcp_project
      id: primary_project
      variant: gcpfree
      startup_script:
        type: deployment_manager
        path: ./startup
        custom_properties:
          - key: userNameWindows
            value: student
      cleanup_script:
        type: deployment_manager
        path: ./cleanup
        custom_properties:
          - key: primary_project_zone
            reference: primary_project.default_zone
    - type: gcp_user
      id: primary_user
      permissions:
      - project: primary_project
        roles:
        - roles/editor
        - roles/appengine.appAdmin
        - roles/bigquery.admin
        - roles/bigquery.user
    - type: aws_account
      id: the_account
      variant: aws_vpc
      startup_script:
        type: cloud_formation
        path: ./lab.template
      user_policy: ./iam_policy.json
      account_restrictions:
        allow_spot_instances: true
        allow_subnet_deletion: false
        allow_vpc_deletion: false
        allowed_rds_instances: ['db.t2.micro']
  student_visible_outputs:
    - label: Open GCP Console
      reference: primary_project.console_url
    - label: GCP Project
      reference: primary_project.project_id
    - label: GCP Username
      reference: primary_user.username
    - label: GCP Password
      reference: primary_user.password
    - label: InstanceDns
      reference: primary_project.startup_script.InstanceDns
    - label: AWS Account Number
      reference: the_account.account_number
    - label: Username
      reference: the_account.username
    - label: password
      reference: the_account.password
    - label: AWS Console URL
      reference: the_account.console_url

assessment:
  passing_percentage: 75.0
  steps:
  - title: Create a Cloud Storage bucket
    maximum_score: 5
    student_messages:
      success: Great job! You created the bucket!
      bucket_missing: Oops! No bucket found.
      bucket_misconfigured: Hmm. The bucket is there, but it is misconfigured.
    services:
    - primary_project.StorageV1
    code: |-
        def check(handles:, maximum_score:, resources:)
          storage_handle = handles['primary_project.StorageV1']
          raise 'Invalid handle' if storage_handle.nil?
          # Check for bucket, stubbed for testing
          found_bucket = true
          unless found_bucket
            return { score: 0, message: 'bucket is missing' ,student_message: 'bucket_missing' }
          end
          # Check bucket configuration, stubbed for testing
          bucket_configured_correctly = true
          unless bucket_configured_correctly
            return { score: 2, message: 'bucket is misconfigured', student_message: 'bucket_misconfigured' }
          end
          { score: max_score, message: 'step completed', student_message: 'success' }
        end

